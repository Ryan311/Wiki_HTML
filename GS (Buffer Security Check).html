<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=cp936">
    <title>GS (Buffer Security Check)</title>
    <link rel="stylesheet" type="text/css" href="css/shCoreDefault.css"/>
    <link rel="Stylesheet" type="text/css" href="static/css/wiki.css">
    <link rel="Stylesheet" type="text/css" href="static/bootstrap/css/bootstrap.min.css">
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/js/wiki.js"></script>
    <script type="text/javascript" src="static/js/shCore.js"></script>
    <script type="text/javascript" src="static/js/shBrushPython.js"></script>
    <script type="text/javascript" src="static/js/shBrushCpp.js"></script>
    <script type="text/javascript" src="static/js/shBrushErlang.js"></script>
    <script type="text/javascript" src="static/js/shBrushBash.js"></script>
    <script type="text/javascript" src="static/js/shBrushRuby.js"></script>
    <script type="text/javascript" src="static/js/shBrushSql.js"></script>
    <script type="text/javascript" src="static/js/shBrushJScript.js"></script>
    <script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body>
<nav class="navbar navbar-default navbar-inverse" role="navigation">
 <div class="container">
    <div class="navbar-header">
<button data-target=".bs-navbar-collapse" data-toggle="collapse" type="button" class="navbar-toggle">
	<span class="sr-only"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </button>
	<a class="navbar-brand" href="main.html">Rick's wiki</a>
    </div>
    <div class="collapse navbar-collapse">
	<ul class="nav navbar-nav">
	    <li><a href="main.html">Home</a></li>
	    <li><a href="TODO.html">TODO</a></li>
	</ul>
    </div>
 </div>
</nav>
<div class="container content-body">
    
<div class="toc">
<ul>
<li><a href="#toc_0.1">Buffer Overrun</a>
<li><a href="#toc_0.2">防止Buffer overrun的措施 </a>
<li><a href="#toc_0.3">基于Cookie的Stack Buffer安全检测 </a>
<li><a href="#toc_0.4">More</a>
</ul>
</ul>
</div>
<h2 id="toc_0.1">Buffer Overrun</h2>
<p>
buffer是程序用来存储数据的连续内存区域，一旦分配完成，其起始地址和大小便
固定下来。程序运行过程中，如果使用了超出buffer的区域，那么就发生了buffer
overflow（缓冲区溢出）或者buffer overrun(缓冲区越界）。如果该缓冲区分配在
stack上，就称之为stack buffer overrun;如果分配在heap，就称为heap overflow。
</p>

<p>
stack buffer overrun会冲毁thread自身及其父线程的栈信息，我们知道在当前stack
frame中，EBP+4为函数返回地址，EBP+8为最后一个参数，EBP+C：倒数第二个参数...。
如果EBP+4处的内容被写入一个非法地址，那么函数调用退出的时候就会跳转到一个非
法地址，转而执行非法程序。这就是利用stack buffer overrun进行恶意攻击的基本原理。
</p>
<blockquote>
local 2         ebp-8      Low 
local 1         ebp-4
caller ebp      ebp
return address  ebp+4
para 1          ebp+8
para 2          ebp+C
para 3          ebp+10
para 4          ebp+14      High
</blockquote>

<p>
在vc6.0中，如果程序为debug 版本，by default会启用stack buffer overrun的检测。
而在release版本中，则关闭了对其的检测。而在vc8以上版本编译器中，则采用了基于
Cookie的stack buffer安全检查机制, 这时的Stack frame如下所示：
</p>
<blockquote>
local 2         ebp-C      Low 
local 1         ebp-8
<strong>cookie          ebp-4</strong>    ebp XOR cookie
caller ebp      ebp
return address  ebp+4
para 1          ebp+8
para 2          ebp+C
para 3          ebp+10
para 4          ebp+14      High
</blockquote>

<h2 id="toc_0.2">防止Buffer overrun的措施 </h2>
<p>
首先简要介绍在Debug版本下的stack orverrun(VC8及以上）的检测机制：
</p>
<ul>
<li>
  1. VC8在紧邻栈指针的位置分配4个字节用于存放安全Cookie。安全Cookie就像一个安全护栏， 用于保护其下的栈指针和函数返回地址，他位于局部变量和重要的栈帧信息（栈帧指针及函数 返回地址）。这样，如果Cookie之上的局部变量发生溢出，在漫延到栈帧信息前会覆盖Cookie, 因此检查Cookie的完整性便可以探测到可能危及栈信息的溢出情况。

</ul>

<ul>
<li>
  2. 在给每个局部变量分配空间时，除了补齐内存空间所需的零头部分，编译器还会给每个变 量多分配8个字节，分别放置于变量的前后各4个字节，并将其初始化为0xcccccccc。这样，每个变量 相当于有了前后2个屏障。一旦这2道屏障受损，则会产生中断（正是cc编码）。

</ul>

<ul>
<li>
  以上开销较大，通常只用于调试版本

</ul>

<h2 id="toc_0.3">基于Cookie的Stack Buffer安全检测 </h2>
<p>
VS8及以上编译器(VS2005及以上)Release版本中采用Cookie机制来防止stack overrun, /GS选项用于控制该功能， 默认打开
</p>
<ul>
<li>
  1. 编译器在编译可能发生stack buffer orverrun的函数时，会定义一个特别的局部变量，该局 部变量被分配在栈帧中所有其他局部变量和栈帧与函数返回之间，这个变量专门用来保存Cookie, 我们将其称为Cookie变量。Cookie变量是一个32位的整数，他的值从全局变量_security_cookie中得到。 （该全局变量是定义在C运行库中，我们可以看到默认安装路径下的源代码：c:\program...\visu..8\VC\crt\src\gs_cookie.c可以看到其定义：

</ul>
<blockquote>
#define DEFAULT_SECURITY_COOKIE 0xBB40E64E
DECLSPEC_SELECTRANY UINT_PRT  _security_cookie=DEFAULT_SECURITY_COOKIE;
</blockquote>

<ul>
<li>
  2. 在VC8编译器启动的启动函数中（如WinMainCRTStartup)还会调用_security_init_cookie函数对该变量进行正式的初始化。在crt0.c中，可以看到启动函数的源码如下：

</ul>
<blockquote>
int _tmainCRTStartup(void)
{
_security_init_cookie();//初始化cookie
</blockquote>
<blockquote>
......
</blockquote>
<blockquote>
}
</blockquote>
<p>
因为是在启动函数中初始化全局变量_security_cookie，所以在该process以后的运行过程中，Cookie值是保持不变的。
</p>

<ul>
<li>
  3. 编译器在为一个函数插入安全Cookie时，他还会与当时的EBP做一次xor,然后将其保存到Cookie变量中，这些指令通常出现在函数的序言(prolog)之后，其典型过程如下：

</ul>
<blockquote>
push ebp                                    //将caller的ebp压入栈中
mov ebp,esp                                 //更新ebp基址， 指向caller的ebp
sub esp,0x18                                //为局部变量分配栈空间
mov eax,[applica!_security_Cookie]          //将_security_cookie存入eax
xor eax,ebp                                 //与ebp xor
mov [ebp-0x4],eax                           //存入cookie变量
</blockquote>

<p>
与EBP xor的两个好处：
<br>1. 提高安全cookie的随机性，尽可能使每个函数的_security_cookie都不同。
<br>2. 检查EBP值是否被破坏。因为在检查Cookie变量时，会再与EBP再进行一次xor,如果EBP没有发生变化，那么两次xor后Cookie变量的值就应该成全局安全变量_security_cookie的值。
其典型的代码如下：
</p>
<blockquote>
mov ecx, [ebp-0x4]
pop edi
xor ecx,ebp                                 //再xor 一次
pop esi
call applica!_security_check_cookie(0x***) //开始检查_security_cookie
mov esp,ebp
pop ebp
ret
</blockquote>

<ul>
<li>
  4. 安全检查失败处理

</ul>
<p>
因为stack buffer overrun可能覆盖掉函数的本来返回地址，使函数返回到未知的地方，从而使程序出现不可预期的后果。因此这种exception被看作是fatal error,
一旦遇到这种错误，程序就会马上终止。但为了debug,在terminate process之前，_report_gsfailure函数会记录下错误发生时的重要信息，并提供JIT调试机会。
</p>
<pre  //当出现错误时， 会跳转到_report_gsfailure中处理错误， 如果在Driver中就表现为BSOD， 栈中可以看到它 >
    void _security_check_cookie(UINT _PTR cookie)
    {
    _asm
          {
              cmp ecx,_security_cookie;
              jne failure;
              rep ret;
        failure:

              jmp _report_gsfailure;
          }
    }
</pre>

<h2 id="toc_0.4">More</h2>
<ul>
<li>
  在Windbg中可以看到某个程序或Driver的Cookie值

</ul>
<blockquote>
&gt;x RtkBtfilter!_security_cookie
8b493d14          RtkBtfilter!__security_cookie = 0xf114302c
</blockquote>
        
<ul>
<li>
  可以用uf命令查看几个与Cookie相关的函数

</ul>
<blockquote>
&gt;u RtkBtfilter!__security_cookie
&gt;u RtkBtfilter!__security_check_cookie
</blockquote>
    
<ul>
<li>
  并不是每个函数调用时都会加Cookie保护， 由编译器判断有可能发生overrun的时候才会加， 这取决于函数中是否有GS Buffer

</ul>
<p>
GS Buffers定义：
</p>
<ul>
<li>
  A buffer overrun security check is performed on a GS buffer. A GS buffer can be one of these:

<li>
  An array that is larger than 4 bytes, has more than two elements, and has an element type that is not a pointer type.

<li>
  A data structure whose size is more than 8 bytes and contains no pointers.

<li>
  A buffer allocated by using the _alloca function.

<li>
  Any class or structure that contains a GS buffer.

</ul>
    
<p>
函数定义如下变量时， 它就是包含了GS Buffers 
</p>
<blockquote>
char buffer[20];
int buffer[20];
struct { int a; int b; int c; int d; } myStruct;
struct { int a; char buf[20]; };
</blockquote>
    
<p>
而如下变量就不是
</p>
<blockquote>
char *pBuf[20];
void *pv[20];
char buf[4];
int buf[2];
struct { int a; int b; };
</blockquote>
    
<p>
Reference:   <a href="http://msdn.microsoft.com/en-us/library/8dbf701c.aspx">http://msdn.microsoft.com/en-us/library/8dbf701c.aspx</a> 
</p>


   <hr />
   <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rickhuang'; // required: replace example with your forum shortname

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</body>
</html>
