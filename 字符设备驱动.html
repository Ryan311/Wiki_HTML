<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=cp936">
    <title>×Ö·ûÉè±¸Çı¶¯</title>
    <link rel="stylesheet" type="text/css" href="css/shCoreDefault.css"/>
    <link rel="Stylesheet" type="text/css" href="static/css/wiki.css">
    <link rel="Stylesheet" type="text/css" href="static/bootstrap/css/bootstrap.min.css">
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/js/wiki.js"></script>
    <script type="text/javascript" src="static/js/shCore.js"></script>
    <script type="text/javascript" src="static/js/shBrushPython.js"></script>
    <script type="text/javascript" src="static/js/shBrushCpp.js"></script>
    <script type="text/javascript" src="static/js/shBrushErlang.js"></script>
    <script type="text/javascript" src="static/js/shBrushBash.js"></script>
    <script type="text/javascript" src="static/js/shBrushRuby.js"></script>
    <script type="text/javascript" src="static/js/shBrushSql.js"></script>
    <script type="text/javascript" src="static/js/shBrushJScript.js"></script>
    <script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body>
<nav class="navbar navbar-default navbar-inverse" role="navigation">
 <div class="container">
    <div class="navbar-header">
<button data-target=".bs-navbar-collapse" data-toggle="collapse" type="button" class="navbar-toggle">
	<span class="sr-only"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </button>
	<a class="navbar-brand" href="main.html">Rick's wiki</a>
    </div>
    <div class="collapse navbar-collapse">
	<ul class="nav navbar-nav">
	    <li><a href="main.html">Home</a></li>
	    <li><a href="TODO.html">TODO</a></li>
	</ul>
    </div>
 </div>
</nav>
<div class="container content-body">
    
<div class="toc">
<ul>
<li><a href="#toc_1">ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å· </a>
<li><a href="#toc_2">é‡è¦æ•°æ®ç»“æ„</a>
<ul>
<li><a href="#toc_2.1">container_of</a>
</ul>
</ul>
</div>

<h1 id="toc_1">ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å· </h1>
<ul>
<li>
  ç”±ls -læ˜¾ç¤ºå‡ºçš„ä½äº/devç›®å½•ä¸‹çš„ç‰¹æ®Šæ–‡ä»¶(æˆ–ç§°ä¸ºè®¾å¤‡æ–‡ä»¶)

<ul>
<li>
  ç¬¬ä¸€åˆ—ä¸º'c',  å­—ç¬¦è®¾å¤‡é©±åŠ¨

<li>
  ç¬¬ä¸€åˆ—ä¸º'b',  å—è®¾å¤‡é©±åŠ¨ 

</ul>
<li>
  ä¸»è®¾å¤‡å·æ ‡è¯†è®¾å¤‡å¯¹åº”çš„é©±åŠ¨ç¨‹åºï¼Œ å¦‚/dev/nullå’Œ/dev/zeroç”±è®¾å¤‡é©±åŠ¨ç¨‹åº1ç®¡ç†

<li>
  æ¬¡è®¾å¤‡å·ç”±å†…æ ¸ä½¿ç”¨ï¼Œ ç”¨äºæ­£ç¡®ç¡®å®šè®¾å¤‡æ–‡ä»¶æ‰€æŒ‡çš„è®¾å¤‡ã€‚ å¯ä»¥é€šè¿‡æ¬¡è®¾å¤‡å·è·å¾—ä¸€ä¸ªæŒ‡å‘å†…æ ¸è®¾å¤‡çš„ç›´æ¥æŒ‡é’ˆ

<li>
  å†…æ ¸ä¸­, dev_tç±»å‹(&lt;linux/types.h&gt;)ç”¨æ¥ä¿å­˜è®¾å¤‡ç¼–å·----åŒ…æ‹¬ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·

<li>
  åŠ¨æ€åˆ†é…ä¸»è®¾å¤‡å·çš„æƒ…å†µä¸‹ï¼Œ æ— æ³•é¢„å…ˆåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œ å¯ä»¥ç”¨è„šæœ¬å®‰è£…ï¼Œ å…ˆåŠ è½½è®¾å¤‡ï¼Œ å†ä»/proc/devicesä¸­è¯»æ¨¡å—çš„ä¸»è®¾å¤‡å·ï¼Œ å†åˆ›å»ºç›¸åº”çš„è®¾å¤‡èŠ‚ç‚¹

</ul>

<h1 id="toc_2">é‡è¦æ•°æ®ç»“æ„</h1>
<ul>
<li>
  &lt;linux/fs.h&gt;    struct file_operationsï¼Œ fops(æŒ‡å‘è¯¥ç»“æ„çš„æŒ‡é’ˆ)

<ul>
<li>
  è¯¥ç»“æ„åŒ…å«ä¸€ç»„å‡½æ•°æŒ‡é’ˆï¼Œ æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶å’Œä¸€ç»„å‡½æ•°å…³è”,  è¿™äº›æ“ä½œç”¨æ¥å®ç°ç³»ç»Ÿè°ƒç”¨

<li>
  è¿™ä¸ªç»“æ„çš„æ¯ä¸€ä¸ªå­—æ®µéƒ½å¿…é¡»æŒ‡å‘é©±åŠ¨ç¨‹åºä¸­å®ç°ç‰¹å®šæ“ä½œçš„å‡½æ•°ï¼Œ å¯¹äºä¸æ”¯æŒçš„æ“ä½œï¼Œ å¯¹åº”å­—æ®µå¯è®¾ä¸ºNULL

<li>
  è¯¥ç»“æ„çš„ç¬¬ä¸€ä¸ªå­—æ®µå¹¶ä¸æ˜¯ä¸€ä¸ªæ“ä½œï¼Œ è€Œæ˜¯æŒ‡å‘â€œæ‹¥æœ‰â€è¯¥ç»“æ„çš„æ¨¡å—çš„æŒ‡é’ˆ
<pre>
        struct file_operations scull_fops = {
            .owner = THIS_MODULE,
            .llseek = scull_llseek,
            .read = scull_read,
            .write = scull_write,
            .ioctl = scull_ioctl,
            .open = scull_open,
            .release = scull_release,t
    *b
</pre>

</ul>
</ul>
    
<ul>
<li>
  &lt;linux/fs.h&gt;    struct file     filp(æŒ‡å‘è¯¥ç»“æ„çš„æŒ‡é’ˆ)

<ul>
<li>
  ä¸ç”¨æˆ·ç©ºé—´ç¨‹åºçš„FILEæ²¡æœ‰ä»»ä½•å…³è”ï¼Œ æ˜¯ä¸€ä¸ªå†…æ ¸ç»“æ„ï¼Œ ä¸ä¼šå‡ºç°åœ¨ç”¨æˆ·ç©ºé—´

<li>
  è¯¥ç»“æ„ä»£è¡¨ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œ ç”±å†…æ ¸åœ¨openæ—¶åˆ›å»ºï¼Œ å¹¶ä¼ é€’ç»™åœ¨è¯¥æ–‡ä»¶ä¸Šè¿›è¡Œæ“ä½œçš„æ‰€æœ‰å‡½æ•°ï¼Œ ç›´åˆ°æœ€åçš„closeå‡½æ•°

<li>
  é‡è¦æˆå‘˜:   mode_t f_mode; struct file_operations *f_op;(ä¸æ–‡ä»¶ç›¸å…³æ“ä½œ, å¯é‡è½½)

</ul>
</ul>
    
<ul>
<li>
  &lt;linux/fs.h&gt;    struct inode

<ul>
<li>
  å†…æ ¸ç”¨inodeç»“æ„åœ¨å†…éƒ¨è¡¨ç¤ºæ–‡ä»¶ï¼Œ ä¸fileä¸åŒã€‚ å®ƒä»¬çš„å…³ç³»ç±»ä¼¼è¿›ç¨‹å’Œç¨‹åºçš„å…³ç³»ã€‚

<li>
  è¯¥ç»“æ„ä¸­åŒ…å«å¤§é‡ä¸æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯

<ul>
<li>
  dev_t i_rdev        è¡¨ç¤ºè®¾å¤‡æ–‡ä»¶çš„inodeç»“æ„

<li>
  struct cdev *i_cdev     è¡¨ç¤ºå­—ç¬¦è®¾å¤‡çš„å†…æ ¸çš„å†…éƒ¨ç»“æ„ï¼Œ å½“inodeæŒ‡å‘ä¸€ä¸ªå­—ç¬¦è®¾å¤‡æ–‡ä»¶æ—¶ï¼Œ è¯¥å­—æ®µåŒ…å«äº†æŒ‡å‘struct cdevç»“æ„çš„æŒ‡é’ˆ

</ul>
</ul>
</ul>

<ul>
<li>
  &lt;linux/cdev.h&gt;  struct cdev

<ul>
<li>
  å†…æ ¸å†…éƒ¨ä½¿ç”¨è¯¥ç»“æ„è¡¨ç¤ºå­—ç¬¦è®¾å¤‡

<li>
  å­—ç¬¦è®¾å¤‡æ³¨å†Œçš„ç›¸å…³æ“ä½œå‡½æ•°

<ul>
<li>
  cdev_alloc()        åˆ†é…è¯¥ç»“æ„

<li>
  cdev_init()         åˆå§‹åŒ–å·²åˆ†é…çš„ç»“æ„

<li>
  cdev_add()          å‘Šè¯‰å†…æ ¸è¯¥ç»“æ„çš„ä¿¡æ¯            ç›¸å½“äºDeviceAdd(), è€Œmodule_init()ä¸­çš„å‡½æ•°ç›¸å½“äºDriverEntry()

<li>
  cdev_del()          ä»ç³»ç»Ÿä¸­ç§»é™¤ä¸€ä¸ªå­—ç¬¦è®¾å¤‡

</ul>
</ul>
</ul>


<h2 id="toc_2.1">container_of</h2>
<ul>
<li>
  container_of(pointer, container_type, container_field)

<li>
  è¯¥å®éœ€è¦ä¸€ä¸ªcontainer_fieldå­—æ®µçš„æŒ‡é’ˆï¼Œ è¯¥å­—æ®µåŒ…å«åœ¨container_typeç±»å‹çš„ç»“æ„ä¸­ï¼Œ ç„¶åè¿”å›åŒ…å«è¯¥å­—æ®µçš„ç»“æ„æŒ‡é’ˆ
<pre>
    struct scull_dev {
        struct scull_qset *data;
        int quantum;
        int qset;
        unsigned int access_key;
        struct semaphore sem;
        struct cdev cdev;
    }
    struct scull_dev *dev;  //device information

    dev =  container_of(inode-&gt;i_cdev, struct scull_dev, cdev);
    filp-&gt;private_data = dev; // for other methods
</pre>

</ul>

<p>
*container_ofçš„å®ç°*
</p>
<pre>
    
    #define offsetof(TYPE, MEMBER) ((size_t) &amp; ((TYPE *)0)-&gt;MEMBER)
    
    /** 
    * container_of - cast a member of a structure out to the containing structure 
    * @ptr:        the pointer to the member. 
    * @type:       the type of the container struct this is embedded in. 
    * @member:     the name of the member within the struct. 
    * */ 
    #define container_of(ptr, type, member) ({                      \ 
        const typeof(((type *)0)-&gt;member) *__mptr = (ptr);    \ 
        (type *)((char *)__mptr - offsetof(type,member));})
</pre>


   <hr />
   <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rickhuang'; // required: replace example with your forum shortname

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</body>
</html>
