<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=cp936">
    <title>Windows</title>
    <link rel="stylesheet" type="text/css" href="css/shCoreDefault.css"/>
    <link rel="Stylesheet" type="text/css" href="static/css/wiki.css">
    <link rel="Stylesheet" type="text/css" href="static/bootstrap/css/bootstrap.min.css">
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/js/wiki.js"></script>
    <script type="text/javascript" src="static/js/shCore.js"></script>
    <script type="text/javascript" src="static/js/shBrushPython.js"></script>
    <script type="text/javascript" src="static/js/shBrushCpp.js"></script>
    <script type="text/javascript" src="static/js/shBrushErlang.js"></script>
    <script type="text/javascript" src="static/js/shBrushBash.js"></script>
    <script type="text/javascript" src="static/js/shBrushRuby.js"></script>
    <script type="text/javascript" src="static/js/shBrushSql.js"></script>
    <script type="text/javascript" src="static/js/shBrushJScript.js"></script>
    <script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body>
<nav class="navbar navbar-default navbar-inverse" role="navigation">
 <div class="container">
    <div class="navbar-header">
<button data-target=".bs-navbar-collapse" data-toggle="collapse" type="button" class="navbar-toggle">
	<span class="sr-only"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </button>
	<a class="navbar-brand" href="main.html">Rick's wiki</a>
    </div>
    <div class="collapse navbar-collapse">
	<ul class="nav navbar-nav">
	    <li><a href="main.html">Home</a></li>
	    <li><a href="TODO.html">TODO</a></li>
	</ul>
    </div>
 </div>
</nav>
<div class="container content-body">
    
<div class="toc">
<ul>
<li><a href="#toc_1">Windows</a>
<ul>
<li><a href="#toc_1.1">Driver Concepts</a>
<li><a href="#toc_1.2">WDF</a>
<li><a href="#toc_1.3">UMDF</a>
<ul>
<li><a href="#toc_1.3.1">Benefit from UMDF driver</a>
<li><a href="#toc_1.3.2">System-supplied components</a>
<li><a href="#toc_1.3.3">I/O request Flow</a>
</ul>
<li><a href="#toc_1.4">UserMode</a>
<ul>
<li><a href="#toc_1.4.1">PE Format</a>
</ul>
<li><a href="#toc_1.5">System</a>
<li><a href="#toc_1.6">Bat</a>
<li><a href="#toc_1.7">Work Debug</a>
<li><a href="#toc_1.8">Work experience</a>
</ul>
</ul>
</div>

<h1 id="toc_1">Windows</h1>
<hr />
<h2 id="toc_1.1"><a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff554836(v=vs.85).aspx">Driver Concepts</a></h2>
<ul>
<li>
  User mode and kernel mode

<li>
  Virtual address spaces

<li>
  Device nodes and device stacks

<li>
  I/O request packets

<li>
  Driver stacks

<li>
  Minidrivers and driver pairs

<li>
  KMDF as a generic driver pair model

<li>
  Upper and lower edges of drivers

<li>
  <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff541224(v=vs.85).aspx">Device Identification Strings</a>

<ul>
<li>
  Device IDs

<li>
  Hardware IDs

<li>
  Compatible IDs

<li>
  Instance IDs

<li>
  Device instance IDs

<li>
  <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff540024(v=vs.85).aspx">Container ID</a>

<ul>
<li>
  Starting with Windows 7, the operating system uses a new ID (container ID) to group one or more devnodes that originated from 

<li>
  and belong to each instance of a particular physical device.  

<li>
  提供多功能的一个设备，加载起来后会有多个devnode，会在Device and Printers里显示多个单独设备，无法组织到一起，所以加入了该ID，

<li>
  将属于同一个设备的Devnode组织在一起！

<li>
  Generate Container ID

<ul>
<li>
  A bus driver provides a container ID

<li>
  The PnP manager generates a container ID through the removable device capability

<li>
  The PnP manager generates a container ID through an override of the removable device capability

<ul>
<li>
  Although the override mechanism does not change the value of the removable device capability, it forces the PnP manager 

<li>
  to use the <strong>override setting</strong> and <em>not the value of the removable device capability</em> when generating container IDs for devices. 

<li>
  <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff541144(v=vs.85).aspx">通过注册表来控制，这样的话可以不用设备提供的removable device capability, 客户报的问题就是通过这种方式来修改的</a>

<li>
  <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff540101(v=vs.85).aspx">Container IDs Generated from a Removable Device Capability Override</a>

</ul>
</ul>
</ul>
</ul>
</ul>
<h2 id="toc_1.2">WDF</h2>
<pre>
KMDF version	Release method	            Included in this version of     Windows	Drivers using it run on
1.13            Windows 8.1 Preview WDK     Windows 8.1 Preview             Windows 8.1 Preview
1.11            Windows 8 WDK               Windows 8                       Windows Vista and later
1.9             Windows 7 WDK               Windows 7                       Windows XP and later
</pre>
<h2 id="toc_1.3">UMDF</h2>
<pre>
UMDF version	Release method	            Included in this version of Windows	    Drivers using it run on
2.0             Windows 8.1 Preview WDK     Windows 8.1 Preview                     Windows 8.1 Preview
1.11            Windows 8                   WDK Windows 8                           Windows Vista and later
1.9             Windows 7                   WDK Windows 7                           Windows XP and later
</pre>
<ul>
<li>
  UMDF1.x:    requires using the COM programming model to write C++ code.

<li>
  UMDF2.0:    write a UMDF driver in the C programming language that calls many of the methods that are available to KMDF drivers

<li>
  File system drivers, display drivers, and print drivers cannot be UMDF drivers.

</ul>
<h3 id="toc_1.3.1">Benefit from UMDF driver</h3>
<ul>
<li>
  稳定性更高，因为只能访问进程的地址空间，而不像KMDF那样可以访问整个内核空间

<li>
  UMDF driver运行在LocalService account下，对用户数据及系统文件有有限的访问权限

<li>
  运行环境相对kernel-mode driver相对简单，不用考虑IRQL、page faults和thread context。

<li>
  UMDF2和KMDF可以相互转换，调用的函数大部分相同

<li>
  UMDF2可以在使用user-mode debugger，也可以使用kernel-mode debugger调试，wdfkd.dll有新增函数

</ul>
<h3 id="toc_1.3.2">System-supplied components</h3>
<ul>
<li>
  Driver host process(<strong>Wudfhost.ext</strong>)

<ul>
<li>
  a child process of the driver manager service

<li>
  runs in the <strong>LocalService</strong> account

<li>
  Device pooling

</ul>
<li>
  Driver manager

<li>
  Reflector

</ul>
<h3 id="toc_1.3.3">I/O request Flow</h3>
<pre>
an application calls a Win32 file I/O function(such as CreateFile, ReadFileEx, or DeviceIoControl)
==&gt; the reflector ==&gt; the driver host process ==&gt; the top of the correct user-mode device stack
|   ==&gt; the reqeust is completed by one of the drivers in the user-mode stack
|   ==&gt; forward to the reflector ==&gt; the reflector ==&gt; kernel-mode stack for completion
</pre>

<hr />
<h2 id="toc_1.4">UserMode</h2>
<ul>
<li>
  DeviceIOControl的Overlapped参数

<ul>
<li>
  该参数只有在打开文件句柄时指明FILE_FLAG_OVERLAPPED才有效

<li>
  如果带有Overlapped参数，则DeviceIOControl参数将马上返回，且LastError为ERROR_IO_PENDING

<li>
  如果在Driver中马上将该Reqeust Complete，错误码会在Overlapped结构中保存
<pre // E:\SampleDriver\NONPNP_Win8>
        OverLap.hEvent = CreateEvent(NULL, TRUE, TRUE, "");   
        OverLap.Offset = 0;  
        OverLap.OffsetHigh = 0; 
        printf("\nCalling DeviceIoControl IOCTL_NONPNP_IORETURN_TEST\n");
        bRc = DeviceIoControl ( hDevice,
                                (DWORD) IOCTL_NONPNP_IORETURN_TEST,
                                InputBuffer,
                                10,
                                OutputBuffer,
                                10,
                                &amp;bytesReturned,
                                &amp;OverLap 
                                );
        printf ( "  Error in DeviceIoControl : %x\n", bRc);
        printf ( "  Error in DeviceIoControl : %x\n", GetLastError());
        dwWaitResult = WaitForSingleObject(OverLap.hEvent, 0);
        if(dwWaitResult == WAIT_OBJECT_0)
        {
            printf(" Event is set signaled \n");
            bRc = GetOverlappedResult(hDevice, &amp;OverLap, &amp;bytesReturned, FALSE) ; 
            printf ("Error in DeviceIoControl : bRc(%x), Error(%x)\n", bRc, GetLastError());
        }
        else
        {
            printf(" Event is not set signaled\n"); 
        }
</pre>

</ul>
</ul>


<hr />

<h3 id="toc_1.4.1">PE Format</h3>
<ul>
<li>
  <a href="http://msdn.microsoft.com/en-us/library/ms809762.aspx">http://msdn.microsoft.com/en-us/library/ms809762.aspx</a>

<li>
  Dumpbin.exe in VS

<ul>
<li>
  dumpbin /section:.rsrc rtkbtfilter.sys

<li>
  dumpbin /headers rtkbtfilter.sys

</ul>
<li>
  pefile(python module for PE) 

<ul>
<li>
  <a href="https://code.google.com/p/pefile/">https://code.google.com/p/pefile/</a>

<li>
  <a href="https://code.google.com/p/pefile/wiki/UsageExamples">https://code.google.com/p/pefile/wiki/UsageExamples</a>

</ul>
<li>
  pedump(ruby module for PE)

</ul>
 
<hr />
<h2 id="toc_1.5">System</h2>
<ul>
<li>
  删除系统服务项

<ul>
<li>
  每一个Driver都对应一个Windows Service，该Service在Task Manager的Services List不可见，可以用工具<a href="http://tools.sysprogs.org/srvman/">srvman</a>来查看

<li>
  也可以用cmd-&gt; sc query RtkBtfilter来查看该服务的状态

<li>
  如果BT先安装公版device filter，卸载后，再安装Toshiba device filter，会提供service name or display name already exist

<li>
  原因就是这两个Filter使用的相同的的Service Name&amp;Display Name，即使卸载Driver，该服务RtkBtfilter仍然在Services list里，状态为Stop

<li>
  只有将其从Service list删除才可以重装另一个Driver，因为Service Name&amp;Display Name必须唯一!!!

</ul>
<li>
  DxDiag
<pre>
        A DxDiag, short for Direct X diagnostic, is a listing of the components of your computer. This list includes your CPU, GPU (video card), 
    memory, recent driver updates, and other useful pieces of information about your computer. A DxDiag does not contain any sensitive information
    that Riot or anyone else can use against you; it is just a list of hardware and software installed on your computer.

    DxDiags are used to quickly determine what system hardware or drivers may be conflicting with League of Legends. Whenever posting a technical 
    issue on the support forums, or sending an email to support@riotgames.com, it's a good idea to include this diagnostic.
    Here is a short guide to obtaining a DxDiag:
    *   Press [Windows Key] + 'R' key
    *   Type dxdiag in the field and hit 'Ok'
    *   The DirectX Diagnostic Tool will open. Press the "Save All Information..." button.
    *   Choose where to save the file like your desktop.
    *   Attach the DxDiag to your response.
</pre>

<li>
  无线AP
<pre>
    从win7开始，带有无线网卡（比如8723）的电脑，可以将自己的电脑做成无线AP，将有线网络分享给手机/平板使用。具体操作步骤：
    *   用管理员方式运行附件中的.bat，记得将bat中第二行的AP名字和AP密码设成你需要的。
    *   将有线网络共享给刚刚创建的无线AP:在控制面板中有线网络（本地连接）上点右键--属性--在共享一栏中打上勾，选择对应的无线AP(无线网络连接 2)，见图
    *   每次重启都需重新运行.bat，共享设置过一次下次就不必再设置了
        &gt;netsh wlan show drivers
        &gt;netsh wlan set hostednetwork mode=allow ssid=AP名字 key=AP密码
        &gt;netsh wlan start hostednetwork
        &gt;pause
</pre>

<li>
  UAC (User Account Control) 用户账户控制

<ul>
<li>
  Windows Vista引入，提高系统安全，要求用户在执行可能会影响电脑运行的操作之前提供许可权或管理员密码

</ul>
<li>
  清理系统盘

<ul>
<li>
  OS及一些软件会将更新的东西一直Cache到硬盘里而不清理，所以越长越大，C盘越用越小

<li>
  Outlook会将邮件内容存在一个文件outlook.ost中，它会持续增长，默认放在C:\Users\rui_huang\AppData\Local\Microsoft\Outlook

<li>
  C:\ProgramData\Package Cache中的东西是VS安装时要用的，基本没用但Uninstall VS时如果删除就会Fail

<ul>
<li>
  解决方法， 将上面两个文件夹放到另一个分区（空间大），并在原位置做一个链接，

<ul>
<li>
  mklink /J "C:\ProgramData\Package Cache" "F:\SystemCache\Package Cache"

<li>
  mklink /J "C:\Users\rui_huang\AppData\Local\Microsoft\Outlook" "F:\SystemCache\Outlook"

</ul>
</ul>
<li>
  C:\Windows\WinSxS文件中的内容也有很多重复不用的，但最好不要手动删除，可以用工具Windows Update Clean Tool清理（Windows也自带清理工具）

</ul>
<li>
  桌面上BAT的图标显示错误，变成与PDF文件相同的ICON，看着有些别扭，这可能是360安全卫士惹的祸，误删除了注册表项

<ul>
<li>
  可添加如下注册表项修复
<pre // 保存成一个.reg文件，然后导入， 重新启动explorer.exe就可以了>
    Windows Registry Editor Version 5.00

    [HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.bat]

    [HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.bat\OpenWithList]

    [HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.bat\OpenWithProgids]
    "batfile"=hex:
</pre>

<li>
  查看一下注册表位置，可以看到这个表项下面列出了各种扩展名，如果是ICON或打开文件方式有问题，可以查看该处的注册表项是否正常

</ul>
</ul>
<hr />
<h2 id="toc_1.6">Bat</h2>
<ul>
<li>
  <a href="http://blog.csdn.net/davidhsing/article/details/1996180">for /f</a>
<pre>
    for /f %%i in (a.txt) do echo %%i       //这个会显示a.txt里面的内容，因为/f的作用，会读出a.txt中 的内容。
    for %%i in (a.txt) do echo %%i          //而这个只会显示a.txt这个名字，并不会读取其中的内容。
    for /f "tokens=2 delims= " %%i in (a.txt) do echo %%i   //以空格分割每一行，并显示第二列
    for /f "tokens=* delims= " %%i in (a.txt) do echo %%i   //以空格分割每一行，并显示整行
    for /f "skip=2 tokens=*" %%i in (a.txt) do echo %%i     //忽略文件头两行，显示每一行
    for /f "eol=. tokens=*" %%i in (a.txt) do echo %%i      //eol用来告诉for忽略以.开始的行
</pre>

<li>
  call other.bat para1 para2 ...

<li>
  setlocal enabledelayedexpansion     --&gt;  延时变量绑定

<li>
  find &amp; findstr
<pre>
        1.findstr . 2.txt 或 Findstr "." 2.txt 
        从文件2.txt中查找任意字符，不包括空字符或空行
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        2.findstr .* 2.txt 或 findstr ".*" 2.txt
        从文件2.txt中查找任意字符包括空行和空字符
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        3.findstr "[0-9]" 2.txt
        从文件2.txt中查找包括数字0－9的字符串或行
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        4.findstr "[a-zA-Z]" 2.txt
        从文件2.txt中查找包括任意字符的字符串或行
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        5.findstr "[abcezy]" 2.txt
        从文件2.txt中查找包括a b c e z y字母的字符串或行
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        6.findstr "[a-fl-z]" 2.txt
        从文件2.txt中查找小写字符a-f l-z的字符串，但不包含g h I j k这几个字母。
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        7.findstr "M[abc] [hig]Y" 2.txt
        从文件2.txt中可以匹配 MaiY, MbiY, MahY等…..
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        8. ^和$符号的应用
        ^ 表示行首，"^step"仅匹配 "step hello world"中的第一个单词
        $ 表示行尾，"step$"仅匹配 "hello world step"中最后一个单词
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        9.findstr "[^0-9]" 2.txt
        如果是纯数字的字符串或者行便过滤掉，例如2323423423 这样的字符串，如果是345hh888这样的形式就显示出来。
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        10.findstr "[^a-z]" 2.txt
        同上，如果是纯字母的字符串或者行便过滤掉，例如 sdlfjlkjlksjdklfjlskdf这样的字符，如果是sdfksjdkf99999这样的形式，掺杂着数字就不成了
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        11.*号的作用
        前面已经说过了 ".*"表示搜索的条件是任意字符，*号在正则表达式中的作用不是任何字符，而是表示左侧字符或者表达式的重复次数，*号表示重复的次数为零次或者多次。
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
         
        12.findstr "^[0-9]*$" 2.txt
        这个是匹配找到的纯数字，例如 234234234234，如果是2133234kkjl234就被过滤掉了。
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
        
        13   Findstr "^[a-z]*$" 2.txt
        这个是匹配找到的纯字母，例如 sdfsdfsdfsdf，如果是213sldjfkljsdlk就被过滤掉了
        ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
</pre>

<li>
  echo

<li>
  <a href="wmic.html">wmic</a>    windows下强大的wmic命令行工具

<ul>
<li>
  wmic datafile where name="C:\\Windows\\System32\\Drivers\\RtkBtfilter.sys" get version | findstr [0-9].[0-9] 显示文件Version

</ul>
</ul>


<hr />
<h2 id="toc_1.7"><a href="Work Debug.html">Work Debug</a></h2>

<h2 id="toc_1.8">Work experience</h2>
<ul>
<li>
  Bushound
<pre>
  11.0  CTL    20 00 00 00  00 00 03 00  SEND HCI                12.1.0       //send hci cmd 
  11.0  OUT    05 10 00                  ...                     12.2.0       //hci cmd data: 1005
  11.1  IN     0e 0b 01 05  10 00 fd 03  ........                13.1.0       //hci event: 0xe-&gt;Command Complete Event, 0x0b-&gt;Event length(not include 0xe and 0xb)
               60 05 00 05  00           `....                   13.1.8       //the other-&gt; parameter 
  11.0  CTL    20 00 00 00  00 00 03 00  SEND HCI                14.1.0        
  11.0  OUT    01 10 00                  ...                     14.2.0        
  11.1  IN     0e 0c 01 01  10 00 06 00  ........                15.1.0        
               05 06 02 00  00 05        ......                  15.1.8 
</pre>

</ul>


   <hr />
   <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rickhuang'; // required: replace example with your forum shortname

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</body>
</html>
