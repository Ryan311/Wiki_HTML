<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Stack Overrun</title>
    <link rel="stylesheet" type="text/css" href="css/shCoreDefault.css"/>
    <link rel="Stylesheet" type="text/css" href="static/css/wiki.css">
    <link rel="Stylesheet" type="text/css" href="static/bootstrap/css/bootstrap.min.css">
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/js/wiki.js"></script>
    <script type="text/javascript" src="static/js/shCore.js"></script>
    <script type="text/javascript" src="static/js/shBrushPython.js"></script>
    <script type="text/javascript" src="static/js/shBrushCpp.js"></script>
    <script type="text/javascript" src="static/js/shBrushErlang.js"></script>
    <script type="text/javascript" src="static/js/shBrushBash.js"></script>
    <script type="text/javascript" src="static/js/shBrushRuby.js"></script>
    <script type="text/javascript" src="static/js/shBrushSql.js"></script>
    <script type="text/javascript" src="static/js/shBrushJScript.js"></script>
    <script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body>
<nav class="navbar navbar-default navbar-inverse" role="navigation">
 <div class="container">
    <div class="navbar-header">
<button data-target=".bs-navbar-collapse" data-toggle="collapse" type="button" class="navbar-toggle">
	<span class="sr-only"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
	<span class="icon-bar"></span>
      </button>
	<a class="navbar-brand" href="main.html">Rick's wiki</a>
    </div>
    <div class="collapse navbar-collapse">
	<ul class="nav navbar-nav">
	    <li><a href="main.html">Home</a></li>
	    <li><a href="TODO.html">TODO</a></li>
	</ul>
    </div>
 </div>
</nav>
<div class="container content-body">
    

<p>
Security Cookie：
</p>

<p>
VS8及以上编译器(VS2005及以上)Release版本中采用Cookie机制来防止stack overrun, /GS选项用于控制该功能， 默认打开。
</p>

<p>
实际情况是在调用一个函数时， 会在函数栈上插入一个值， 在函数返回时检查该值是否发生变化， 以确定是否发生了stack overrun
</p>

<pre>
    Low  address   
    
    local 2         ebp-C                     
    local 1         ebp-8
    cookie          ebp-4      ebp XOR cookie
    caller ebp      ebp
    return address  ebp+4
    para 1          ebp+8
    para 2          ebp+C
    para 3          ebp+10
    para 4          ebp+14                  
    
    High address
</pre>

<p>
如上所示在ebp – 4的位置插入了一个cookie。
</p>


 
<p>
<strong>实例分析： Win7下搜索LE设备时出现BSOD</strong>
Dump File:  \\172.29.38.83\bt_sd3\Windows_DUMP\Customer\Lenovo_StackOverrun
</p>

<pre>
CHECK CODE： DRIVER_OVERRAN_STACK_BUFFER (f7)   
A driver has overrun a stack-based buffer.  This overrun could potentially
allow a malicious user to gain control of this machine.
DESCRIPTION
A driver overran a stack-based buffer (or local variable) in a way that would
have overwritten the function's return address and jumped back to an arbitrary
address when the function returned.  This is the classic "buffer overrun"
hacking attack and the system has been brought down to prevent a malicious user
from gaining complete control of it.
Do a kb to get a stack backtrace -- the last routine on the stack before the
buffer overrun handlers and bugcheck call is the one that overran its local
variable(s).
Arguments:
Arg1: 0000f883dfbeb906, Actual security check cookie from the stack
Arg2: 0000f8832ce065cd, Expected security check cookie
Arg3: ffff077cd31f9a32, Complement of the expected security check cookie
Arg4: 0000000000000000, zero
</pre>
 

<p>
从这里可以看到， 提示说发生了stack overrun， cookie值期望的是0000f8832ce065cd， 而实际得到的确是0000f883dfbeb906
可以用命令得到cookie值， 在程序刚开始执行时初始化， 在执行期间是不变的
</p>
<blockquote>
Kd&gt;  x RtkBtfilter!__security_cookie
fffff880054a7790 RtkBtfilter!__security_cookie = 0x0000f8832ce065cd
</blockquote>

<p>
看到就是期望的值。
</p>
 

<p>
打出错误发生时的call stack：
</p>
<pre>
0: kd&gt; k
# Child-SP          RetAddr           Call Site
00 fffff880`0a56f4f8 fffff880`05491d4e nt!KeBugCheckEx
01 fffff880`0a56f500 fffff880`0548c092 RtkBtfilter!__report_gsfailure+0x26
02 fffff880`0a56f540 fffff880`0548bae3 RtkBtfilter!LeBuildEIR+0x462
03 fffff880`0a56f980 fffff880`0548c8c9 RtkBtfilter!LeAdvReportToMsEIR+0x187
04 fffff880`0a56faa0 fffff880`0548a63d RtkBtfilter!LePostProcessAdvReport+0x51
05 fffff880`0a56fb60 fffff880`0546bf7a RtkBtfilter!FilterLePostProcessHciEvent+0x125
06 fffff880`0a56fba0 fffff880`0546f978 RtkBtfilter!FilterProcessEvent+0xf72
07 fffff880`0a56fc50 fffff880`05471ae7 RtkBtfilter!BluetoothAnalyzeEvent+0x60
08 fffff880`0a56fca0 fffff800`04b762ea RtkBtfilter!BluetoothEventThread+0x267
09 fffff880`0a56fd00 fffff800`048ca8e6 nt!PspSystemThreadStartup+0x5a
0a fffff880`0a56fd40 00000000`00000000 nt!KxStartSystemThread+0x16
</pre>
 

<p>
看到是在调用LeBuildEIR函数时发生的栈溢出， 它的Child-SP是fffff880`0a56f540，也就是rsp，反汇编一下这个函数， 只看函数开头部分就可以
</p>


<pre>
0: kd&gt; uf RtkBtfilter!LeBuildEIR

RtkBtfilter!LeBuildEIR [e:\svnworkspace\trunk\hostsw\win7-inbox-driver\rtkfilter\generic\filter_le_process.c @ 3631]:
 3631 fffff880`0548bc30 48895c2408      mov     qword ptr [rsp+8],rbx
 3631 fffff880`0548bc35 55              push    rbp
 3631 fffff880`0548bc36 56              push    rsi
 3631 fffff880`0548bc37 57              push    rdi
 3631 fffff880`0548bc38 4154            push    r12
 3631 fffff880`0548bc3a 4155            push    r13
 3631 fffff880`0548bc3c 4156            push    r14
 3631 fffff880`0548bc3e 4157            push    r15
 3631 fffff880`0548bc40 488dac2400fdffff lea     rbp,[rsp-300h]          rbp指针
 3631 fffff880`0548bc48 4881ec00040000   sub     rsp,400h             rsp指针
 3631 fffff880`0548bc4f 488b053abb0100 
                            mov     rax,qword ptr [RtkBtfilter!__security_cookie (fffff880`054a7790)]
 3631 fffff880`0548bc56 4833c4          xor     rax,rsp
 3631 fffff880`0548bc59 488985f0020000  mov     qword ptr [rbp+2F0h],rax
</pre>

<p>
关键看这三行， 先将cookie值放到rax， 再和rax异或， 然后放入[rbp+2F0]的位置
</p>

<pre>
3631 fffff880`0548bc60 498bd8          mov     rbx,r8
3631 fffff880`0548bc63 4889542440      mov     qword ptr [rsp+40h],rdx
3633 fffff880`0548bc68 488d4c2461      lea     rcx,[rsp+61h]
</pre>

<p>
[rbp+2F0]的位置放入了一个值， 是Cookie 异或 rsp,  Rsp已知   RSP = fffff880`0a56f540
</p>
<blockquote>
则    【rsp+2f0】 =  fffff880`0a56f930
</blockquote>
    
<p>
所以fffff880`0a56f930处存放的值应该是
</p>
<blockquote>
cookie  XOR  rsp  =  0x0000f883<code>2ce065cd  or  fffff880</code>0a56f540 =  FFFF000326B6908D     // Right value
</blockquote>

<p>
查看Memory， 看到fffff880`0a56f930处的值是
</p>
<blockquote>
ffff0003d5e84c46                         // 不一致， 所以这个值有被修改过
</blockquote>
 

<p>
下一步， 查看LeBuildEIR的局部变量：
</p>
<pre>
kd&gt; dv
     Device = 0x00000000`00000000
     EIRParaBuffer = 0xfffffa80`0bd132b0 "???"
     AdvDataBuf = 0x00000000`00000003 "--- memory read error at address 0x00000000`00000003 ---"
     bIsADFlagExist = 0n1 ''
     EIR_Data = struct _EIR_DATA [5]
     EIRRes = struct _HCI_EVENT_EXTENDED_INQUIRY_RESULT
     i = 6
     EIRDataNum = 6
</pre>
 

<p>
看一下数组EIR_Data， 它是一个_IER_DATA结构的数组， 长度为5， 但是在循环时i已经为6了，
</p>

<p>
显然超过了数组的访问范围。 具体来看一下是怎样它是怎样改变cookie的。
</p>
 

<p>
查看EIR_data数组：
</p>
<pre>
0: kd&gt; dt EIR_Data -v
Local var [AddrFlags 90  AddrOff 0000000000000160  Reg/Val rsp (7)] @ 0xfffff8800a56f6a0 Type _EIR_DATA[]
[5] struct _EIR_DATA, 3 elements, 0x82 bytes                    0x82表示_EIR_DATA的包含的字节， sizeof(_EIF_DATA)
   +0x000 Length           : 0x4 ''
   +0x001 EIRDataType      : 0x9 ''
   +0x002 Data             : union &lt;unnamed-tag&gt;, 11 elements, 0x80 bytes
   
0: kd&gt; db 0xfffff8800a56f6a0+82
fffff880`0a56f722  03 19 40 02 00 00 00 00-00 00 00 00 00 00 00 00  ..@.............
fffff880`0a56f732  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
fffff880`0a56f742  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................

0: kd&gt; db 0xfffff8800a56f6a0+82*2
fffff880`0a56f7a4  02 01 06 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
fffff880`0a56f7b4  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
fffff880`0a56f7c4  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................

0: kd&gt; db 0xfffff8800a56f6a0+82*3
fffff880`0a56f826  02 0a 04 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
fffff880`0a56f836  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
fffff880`0a56f846  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................

0: kd&gt; db 0xfffff8800a56f6a0+82*4
fffff880`0a56f8a8  03 03 03 18 00 00 00 00-00 00 00 00 00 00 00 00  ................
fffff880`0a56f8b8  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
fffff880`0a56f8c8  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................

0: kd&gt; db 0xfffff8800a56f6a0+82*5
fffff880`0a56f92a  09 16 0a 18 cd 74 46 4c-e8 d5 03 00 ff ff 32 53  .....tFL......2S
fffff880`0a56f93a  47 05 80 f8 ff ff f8 7f-ed f2 7f 05 00 00 17 00  G...............
fffff880`0a56f94a  00 00 00 00 00 00 00 c1-49 05 80 f8 ff ff 00 00  ........I.......
</pre>

<p>
根据EIR_DATA的定义， 我们列出每个元素的有效数据
</p>
<pre>
[0]:    0x04 0x09
[1]:  0x03 0x19 0x40 0x02
[2]:  0x02 0x01 0x06
[3]:  0x02 0x0a 0x04
[4]:  0x03 0x03 0x03 0x18
[5]:  0x09 0x16 0x0a 0x18 0xcd 0x74 0x46 0x4c 0xe8 0xd5 0x03
</pre>

<p>
而实际数组只能容纳0-4即共5个元素， 对第6个的操作显然会超出数组的范围。 看一下， 这“第6个元素”的地址
</p>
<blockquote>
fffff8800a56f92a  &lt;&lt;&lt;&lt; &gt;&gt;&gt;&gt;&gt;  fffff8800a56f930    与cookie存放的地址如此接近
</blockquote>

<p>
查看Memory
</p>
<pre>
fffff880`0a56f92a       09 16 0a 18 cd 74
fffff880`0a56f930       46 4c e8 d5 03 00 ff ff  32 53 47 05 80 f8 ff ff f8 7f ed f2 7f 05 00 00 17 00 00
</pre>

<p>
由此看到， 对数组超出部分的Copy操作覆盖了函数调用栈中cookie存放位置， Cookie存放位置的十六进制表示：
</p>
<blockquote>
fffff880`0a56f930       ffff0003d5e84c46
</blockquote>

<p>
用ffff0003d5e84c46 和 rsp异或
</p>
<blockquote>
ffff0003d5e84c46 XOR fffff880`0a56f540  =  F883DFBEB906 
</blockquote>
<p>
这个值也就是Arg1给出的错误的Cookie值
</p>

<p>
这个例子对x64下的栈溢出情况作了分析， 与x86下的情况类似， 不同点是在x86下栈中保存的值是Security Cookie与ebp的异或。
</p>


   <hr />
   <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rickhuang'; // required: replace example with your forum shortname

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</body>
</html>
